name: MongoDB ìë™ ë°±ì—…

on:
  schedule:
    # ë§¤ì¼ ìì • 00:00 KST (UTC 15:00 = KST 00:00 ë‹¤ìŒë‚ )
    - cron: '0 15 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm install

      - name: MongoDB ë°±ì—… ì‹¤í–‰
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: node scripts/backup.js

      - name: ë°±ì—… íŒŒì¼ ì»¤ë°‹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"

          # .gitignore ë¬´ì‹œí•˜ê³  ê°•ì œë¡œ backups ì¶”ê°€
          git add -f backups/

          # ë°±ì—… íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì»¤ë°‹
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ìŠ¤í‚µ"
          else
            BACKUP_DATE=$(date +"%Y-%m-%d %H:%M KST")
            git commit -m "ğŸ—„ï¸ ìë™ ë°±ì—…: $BACKUP_DATE"
            git push
          fi

      - name: 15ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ
        run: |
          cd backups
          find . -name "backup_*.json" -type f -mtime +15 -delete

          # ì‚­ì œëœ íŒŒì¼ì´ ìˆìœ¼ë©´ ì»¤ë°‹
          if [[ $(git status --porcelain) ]]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "GitHub Actions"
            git add -A
            git commit -m "ğŸ—‘ï¸ 15ì¼ ì´ìƒëœ ë°±ì—… ìë™ ì‚­ì œ"
            git push
          fi
