name: Build Android APK & Generate QR Code

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install dependencies
        run: npm ci

      - name: Build React app
        run: npm run build
        env:
          CI: false
          REACT_APP_API_BASE_URL: https://bshrsystem-production.up.railway.app/api
          REACT_APP_AI_PROVIDER: openai
          REACT_APP_HOLIDAY_API_KEY: 603c88ccf76cf95f2e1c8ffe7dfa6be2fd88feb4bd6e3000a0293c308885e111

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Build Android APK (Release)
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon

      - name: Get version info
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="v$(date +'%Y.%m.%d')-${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/release/app-release-unsigned.apk \
             android/app/build/outputs/apk/release/BS-HR-System-${{ steps.version.outputs.version }}.apk || true

          # unsigned íŒŒì¼ì´ ì—†ìœ¼ë©´ signed íŒŒì¼ ì°¾ê¸°
          if [ ! -f "android/app/build/outputs/apk/release/BS-HR-System-${{ steps.version.outputs.version }}.apk" ]; then
            find android/app/build/outputs/apk/release/ -name "*.apk" -exec mv {} android/app/build/outputs/apk/release/BS-HR-System-${{ steps.version.outputs.version }}.apk \;
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: BS HR System ${{ steps.version.outputs.version }}
          body: |
            ## ğŸ¢ ë¶€ì„±ìŠ¤í‹¸ HR ì‹œìŠ¤í…œ Android APK

            ### ğŸ“± ë‹¤ìš´ë¡œë“œ ë°©ë²•
            1. ì•„ë˜ APK íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”
            2. Android ê¸°ê¸°ì—ì„œ APKë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”
            3. "ì•Œ ìˆ˜ ì—†ëŠ” ì¶œì²˜" í—ˆìš©ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

            ### ğŸ“‹ ë³€ê²½ì‚¬í•­
            - ë¹Œë“œ ë‚ ì§œ: ${{ steps.version.outputs.date }}
            - ì»¤ë°‹: ${{ github.sha }}

            ### ğŸ”— QR ì½”ë“œë¡œ ë‹¤ìš´ë¡œë“œ
            https://eunsujeong.github.io/BS_HR_System/

          draft: false
          prerelease: false
          files: |
            android/app/build/outputs/apk/release/BS-HR-System-${{ steps.version.outputs.version }}.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install QR code generator
        run: npm install -g qrcode

      - name: Generate APK download QR codes
        run: |
          mkdir -p qr-codes

          # APK ë‹¤ìš´ë¡œë“œ URL
          APK_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/BS-HR-System-${{ steps.version.outputs.version }}.apk"

          echo "Generating QR code for APK: $APK_URL"
          qrcode -o qr-codes/apk-download-qr.png "$APK_URL"

          # ìµœì‹  ë¦´ë¦¬ì¦ˆ í˜ì´ì§€ QR ì½”ë“œ
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/latest"
          qrcode -o qr-codes/release-page-qr.png "$RELEASE_URL"

          # ì •ë³´ ì €ì¥
          cat > qr-codes/download-info.txt <<EOF
          APK ë‹¤ìš´ë¡œë“œ URL: $APK_URL
          ë¦´ë¦¬ì¦ˆ í˜ì´ì§€: $RELEASE_URL
          ë²„ì „: ${{ steps.version.outputs.version }}
          ë¹Œë“œ ë‚ ì§œ: ${{ steps.version.outputs.date }}
          ì»¤ë°‹: ${{ github.sha }}
          EOF

      - name: Create download page
        run: |
          cat > qr-codes/index.html <<'HTMLEOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ë¶€ì„±ìŠ¤í‹¸ HR ì‹œìŠ¤í…œ - APK ë‹¤ìš´ë¡œë“œ</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                  }
                  .container {
                      background: white;
                      border-radius: 24px;
                      padding: 40px;
                      max-width: 600px;
                      width: 100%;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                  }
                  .logo {
                      text-align: center;
                      margin-bottom: 30px;
                  }
                  .logo h1 {
                      font-size: 2em;
                      color: #333;
                      margin-bottom: 8px;
                  }
                  .logo p {
                      color: #666;
                      font-size: 1.1em;
                  }
                  .qr-section {
                      background: #f8f9fa;
                      border-radius: 16px;
                      padding: 30px;
                      text-align: center;
                      margin: 25px 0;
                  }
                  .qr-section h2 {
                      color: #667eea;
                      margin-bottom: 20px;
                      font-size: 1.5em;
                  }
                  .qr-code {
                      background: white;
                      padding: 20px;
                      border-radius: 12px;
                      display: inline-block;
                      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                      margin: 15px 0;
                  }
                  .qr-code img {
                      max-width: 280px;
                      width: 100%;
                      height: auto;
                      display: block;
                  }
                  .download-btn {
                      display: inline-block;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 16px 40px;
                      border-radius: 12px;
                      text-decoration: none;
                      font-size: 1.1em;
                      font-weight: 600;
                      margin: 20px 0;
                      transition: transform 0.2s, box-shadow 0.2s;
                      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                  }
                  .download-btn:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
                  }
                  .info-box {
                      background: #e7f3ff;
                      border-left: 4px solid #667eea;
                      padding: 20px;
                      margin: 25px 0;
                      border-radius: 8px;
                  }
                  .info-box h3 {
                      color: #667eea;
                      margin-bottom: 12px;
                      font-size: 1.2em;
                  }
                  .info-box ul {
                      list-style: none;
                      color: #555;
                  }
                  .info-box li {
                      padding: 8px 0;
                      padding-left: 24px;
                      position: relative;
                  }
                  .info-box li:before {
                      content: "âœ“";
                      position: absolute;
                      left: 0;
                      color: #667eea;
                      font-weight: bold;
                  }
                  .version-info {
                      text-align: center;
                      color: #888;
                      margin-top: 30px;
                      padding-top: 20px;
                      border-top: 2px solid #eee;
                      font-size: 0.9em;
                  }
                  .badge {
                      display: inline-block;
                      background: #667eea;
                      color: white;
                      padding: 6px 14px;
                      border-radius: 20px;
                      font-size: 0.85em;
                      margin: 5px;
                  }
                  @media (max-width: 640px) {
                      .container {
                          padding: 24px;
                      }
                      .logo h1 {
                          font-size: 1.6em;
                      }
                      .qr-code img {
                          max-width: 220px;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="logo">
                      <h1>ğŸ¢ ë¶€ì„±ìŠ¤í‹¸ HR ì‹œìŠ¤í…œ</h1>
                      <p>Android ì•± ë‹¤ìš´ë¡œë“œ</p>
                      <div style="margin-top: 15px;">
                          <span class="badge" id="version">ë¡œë”© ì¤‘...</span>
                          <span class="badge" id="buildDate">ë¡œë”© ì¤‘...</span>
                      </div>
                  </div>

                  <div class="qr-section">
                      <h2>ğŸ“± QR ì½”ë“œë¡œ ë‹¤ìš´ë¡œë“œ</h2>
                      <p style="color: #666; margin-bottom: 15px;">ìŠ¤ë§ˆíŠ¸í° ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”í•˜ì„¸ìš”</p>
                      <div class="qr-code">
                          <img src="apk-download-qr.png" alt="APK Download QR Code">
                      </div>
                      <p style="color: #888; font-size: 0.9em; margin-top: 15px;">
                          QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ APK íŒŒì¼ì´ ë°”ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤
                      </p>
                  </div>

                  <div style="text-align: center;">
                      <a href="#" id="downloadLink" class="download-btn">
                          â¬‡ï¸ APK ì§ì ‘ ë‹¤ìš´ë¡œë“œ
                      </a>
                  </div>

                  <div class="info-box">
                      <h3>ğŸ“‹ ì„¤ì¹˜ ë°©ë²•</h3>
                      <ul>
                          <li>APK íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤</li>
                          <li>Android ê¸°ê¸°ì˜ ì„¤ì •ì—ì„œ "ì•Œ ìˆ˜ ì—†ëŠ” ì¶œì²˜" í—ˆìš©</li>
                          <li>ë‹¤ìš´ë¡œë“œí•œ APK íŒŒì¼ì„ ì‹¤í–‰</li>
                          <li>ì„¤ì¹˜ ì™„ë£Œ í›„ ì•±ì„ ì‹¤í–‰í•˜ì„¸ìš”</li>
                      </ul>
                  </div>

                  <div class="info-box" style="background: #fff3cd; border-left-color: #ff9800;">
                      <h3 style="color: #ff9800;">âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
                      <ul>
                          <li>Android 6.0 (Marshmallow) ì´ìƒ í•„ìš”</li>
                          <li>Google Play ìŠ¤í† ì–´ ë²„ì „ì´ ì•„ë‹Œ ê°œë°œ ë²„ì „ì…ë‹ˆë‹¤</li>
                          <li>ì²˜ìŒ ì„¤ì¹˜ ì‹œ ë³´ì•ˆ ê²½ê³ ê°€ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                      </ul>
                  </div>

                  <div class="qr-section" style="margin-top: 30px;">
                      <h2>ğŸ”— ë¦´ë¦¬ì¦ˆ í˜ì´ì§€</h2>
                      <p style="color: #666; margin-bottom: 15px;">ëª¨ë“  ë²„ì „ í™•ì¸</p>
                      <div class="qr-code">
                          <img src="release-page-qr.png" alt="Release Page QR Code">
                      </div>
                      <p style="color: #888; font-size: 0.9em; margin-top: 15px;">
                          ì´ì „ ë²„ì „ ë° ë³€ê²½ ì´ë ¥ í™•ì¸
                      </p>
                  </div>

                  <div class="version-info" id="versionInfo">
                      ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                  </div>
              </div>

              <script>
                  // download-info.txtì—ì„œ ì •ë³´ ì½ê¸°
                  fetch('download-info.txt')
                      .then(response => response.text())
                      .then(text => {
                          const lines = text.split('\n');
                          const apkUrl = lines[0].split(': ')[1];
                          const releaseUrl = lines[1].split(': ')[1];
                          const version = lines[2].split(': ')[1];
                          const buildDate = lines[3].split(': ')[1];
                          const commit = lines[4].split(': ')[1];

                          // ë‹¤ìš´ë¡œë“œ ë§í¬ ì„¤ì •
                          document.getElementById('downloadLink').href = apkUrl;

                          // ë²„ì „ ì •ë³´ í‘œì‹œ
                          document.getElementById('version').textContent = version;
                          document.getElementById('buildDate').textContent = buildDate;

                          // í•˜ë‹¨ ì •ë³´ ì—…ë°ì´íŠ¸
                          document.getElementById('versionInfo').innerHTML = `
                              <strong>ë²„ì „:</strong> ${version}<br>
                              <strong>ë¹Œë“œ ë‚ ì§œ:</strong> ${buildDate}<br>
                              <strong>ì»¤ë°‹:</strong> ${commit.substring(0, 7)}<br>
                              <a href="${releaseUrl}" style="color: #667eea; text-decoration: none; margin-top: 10px; display: inline-block;">
                                  GitHub ë¦´ë¦¬ì¦ˆ í˜ì´ì§€ â†’
                              </a>
                          `;
                      })
                      .catch(error => {
                          console.error('Error loading download info:', error);
                          document.getElementById('version').textContent = 'ìµœì‹  ë²„ì „';
                          document.getElementById('buildDate').textContent = new Date().toLocaleDateString('ko-KR');

                          // GitHub latest release ë§í¬ë¡œ ëŒ€ì²´
                          const repoUrl = 'https://github.com/EunsuJeong/BS_HR_System';
                          document.getElementById('downloadLink').href = repoUrl + '/releases/latest';
                          document.getElementById('versionInfo').innerHTML = `
                              <a href="${repoUrl}/releases/latest" style="color: #667eea; text-decoration: none;">
                                  ìµœì‹  ë¦´ë¦¬ì¦ˆ ë‹¤ìš´ë¡œë“œ â†’
                              </a>
                          `;
                      });
              </script>
          </body>
          </html>
          HTMLEOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./qr-codes
          publish_branch: gh-pages
          force_orphan: true

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: BS-HR-System-APK
          path: android/app/build/outputs/apk/release/BS-HR-System-${{ steps.version.outputs.version }}.apk
          retention-days: 90

      - name: Create summary
        run: |
          echo "## ğŸ‰ Android APK ë¹Œë“œ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± ë‹¤ìš´ë¡œë“œ ë°©ë²•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **QR ì½”ë“œ í˜ì´ì§€**: https://eunsujeong.github.io/BS_HR_System/" >> $GITHUB_STEP_SUMMARY
          echo "2. **ì§ì ‘ ë‹¤ìš´ë¡œë“œ**: [APK íŒŒì¼](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/BS-HR-System-${{ steps.version.outputs.version }}.apk)" >> $GITHUB_STEP_SUMMARY
          echo "3. **ë¦´ë¦¬ì¦ˆ í˜ì´ì§€**: https://github.com/${{ github.repository }}/releases/latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ ë²„ì „ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ë²„ì „**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ë‚ ì§œ**: ${{ steps.version.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“² QR ì½”ë“œ ì‚¬ìš©ë²•" >> $GITHUB_STEP_SUMMARY
          echo "ìŠ¤ë§ˆíŠ¸í° ì¹´ë©”ë¼ë¡œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ APK íŒŒì¼ì„ ë°”ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
