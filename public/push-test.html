<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 30px;
      }
      .status {
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
        font-weight: bold;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
        transition: background 0.3s;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .log {
        background: #f8f9fa;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
      }
      .log-item {
        padding: 5px;
        border-bottom: 1px solid #dee2e6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“± PWA í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h1>

      <div id="status" class="status info">ì¤€ë¹„ ì¤‘...</div>

      <div style="margin: 20px 0">
        <button id="requestPermission">1ï¸âƒ£ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</button>
        <button id="subscribe" disabled>2ï¸âƒ£ í‘¸ì‹œ êµ¬ë… ë“±ë¡</button>
        <button id="testLocal" disabled>3ï¸âƒ£ ë¡œì»¬ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</button>
        <button id="testBackend" disabled>4ï¸âƒ£ ë°±ì—”ë“œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</button>
      </div>

      <div class="log" id="log">
        <div class="log-item">ğŸ“‹ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
      </div>
    </div>

    <script>
      const log = (message, type = 'info') => {
        const logDiv = document.getElementById('log');
        const item = document.createElement('div');
        item.className = 'log-item';
        const timestamp = new Date().toLocaleTimeString('ko-KR');
        item.innerHTML = `[${timestamp}] ${
          type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ“'
        } ${message}`;
        logDiv.insertBefore(item, logDiv.firstChild);
      };

      const updateStatus = (message, type) => {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
      };

      let subscription = null;

      // VAPID ê³µê°œí‚¤ë¥¼ Uint8Arrayë¡œ ë³€í™˜
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, '+')
          .replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      // 1. ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
      document
        .getElementById('requestPermission')
        .addEventListener('click', async () => {
          try {
            log('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì¤‘...');
            const permission = await Notification.requestPermission();

            if (permission === 'granted') {
              updateStatus('âœ… ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
              log('ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨', 'success');
              document.getElementById('subscribe').disabled = false;
              document.getElementById('testLocal').disabled = false;
            } else {
              updateStatus('âŒ ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
              log('ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨', 'error');
            }
          } catch (error) {
            log(`ì—ëŸ¬: ${error.message}`, 'error');
          }
        });

      // 2. í‘¸ì‹œ êµ¬ë… ë“±ë¡
      document
        .getElementById('subscribe')
        .addEventListener('click', async () => {
          try {
            log('VAPID ê³µê°œí‚¤ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');

            // VAPID ê³µê°œí‚¤ ê°€ì ¸ì˜¤ê¸°
            const response = await fetch(
              'https://bshrsystem-production.up.railway.app/api/push/vapid-public-key'
            );
            const data = await response.json();

            if (!data.success) {
              throw new Error('VAPID ê³µê°œí‚¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            log(`VAPID ê³µê°œí‚¤: ${data.publicKey.substring(0, 20)}...`);

            // Service Worker ë“±ë¡ í™•ì¸
            const registration = await navigator.serviceWorker.ready;
            log('Service Worker ì¤€ë¹„ë¨');

            // í‘¸ì‹œ êµ¬ë…
            subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(data.publicKey),
            });

            log('í‘¸ì‹œ êµ¬ë… ìƒì„±ë¨', 'success');

            // ë°±ì—”ë“œì— êµ¬ë… ì •ë³´ ì „ì†¡
            const subscribeResponse = await fetch(
              'https://bshrsystem-production.up.railway.app/api/push/subscribe',
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  subscription,
                  employeeId: 'TEST001',
                  employeeName: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
                  userAgent: navigator.userAgent,
                  platform: navigator.platform,
                }),
              }
            );

            const subscribeData = await subscribeResponse.json();

            if (subscribeData.success) {
              updateStatus('âœ… í‘¸ì‹œ êµ¬ë…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
              log('ë°±ì—”ë“œì— êµ¬ë… ì •ë³´ ì „ì†¡ ì™„ë£Œ', 'success');
              document.getElementById('testBackend').disabled = false;
            } else {
              throw new Error(subscribeData.error || 'êµ¬ë… ë“±ë¡ ì‹¤íŒ¨');
            }
          } catch (error) {
            updateStatus(`âŒ ì—ëŸ¬: ${error.message}`, 'error');
            log(`êµ¬ë… ë“±ë¡ ì‹¤íŒ¨: ${error.message}`, 'error');
          }
        });

      // 3. ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì•Œë¦¼
      document
        .getElementById('testLocal')
        .addEventListener('click', async () => {
          try {
            log('ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ ì¤‘...');

            const registration = await navigator.serviceWorker.ready;
            await registration.showNotification('ğŸ§ª ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì•Œë¦¼', {
              body: 'ì´ê²ƒì€ Service Workerë¥¼ í†µí•œ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì…ë‹ˆë‹¤.',
              icon: '/logo192.png',
              badge: '/favicon.ico',
              vibrate: [200, 100, 200],
              tag: 'local-test',
              requireInteraction: false,
              data: { type: 'test' },
            });

            updateStatus('âœ… ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            log('ë¡œì»¬ ì•Œë¦¼ í‘œì‹œ ì™„ë£Œ', 'success');
          } catch (error) {
            log(`ë¡œì»¬ ì•Œë¦¼ ì‹¤íŒ¨: ${error.message}`, 'error');
          }
        });

      // 4. ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ (ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œì—ì„œ ì „ì†¡)
      document.getElementById('testBackend').addEventListener('click', () => {
        updateStatus(
          'ğŸ’¡ ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸: ì—°ì°¨ë¥¼ ì‹ ì²­í•˜ê±°ë‚˜ ê³µì§€ì‚¬í•­ì„ ë“±ë¡í•´ë³´ì„¸ìš”!',
          'info'
        );
        log(
          'ë°±ì—”ë“œ ì•Œë¦¼ì€ ì‹¤ì œ ì´ë²¤íŠ¸(ì—°ì°¨ ì‹ ì²­, ê³µì§€ì‚¬í•­ ë“±)ì—ì„œ ìë™ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.'
        );
        log('ë˜ëŠ” ì„œë²„ì—ì„œ ì§ì ‘ sendPushNotification() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”.');
      });

      // ì´ˆê¸°í™”
      window.addEventListener('load', async () => {
        if (!('serviceWorker' in navigator)) {
          updateStatus(
            'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” Service Workerë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            'error'
          );
          log('Service Worker ë¯¸ì§€ì›', 'error');
          return;
        }

        if (!('PushManager' in window)) {
          updateStatus(
            'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            'error'
          );
          log('Push API ë¯¸ì§€ì›', 'error');
          return;
        }

        // Service Worker ë“±ë¡
        try {
          const registration = await navigator.serviceWorker.register(
            '/service-worker.js'
          );
          log('Service Worker ë“±ë¡ë¨', 'success');
          updateStatus(
            'âœ… Service Workerê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì•Œë¦¼ ê¶Œí•œì„ ìš”ì²­í•˜ì„¸ìš”.',
            'success'
          );
        } catch (error) {
          log(`Service Worker ë“±ë¡ ì‹¤íŒ¨: ${error.message}`, 'error');
        }

        // í˜„ì¬ ê¶Œí•œ ìƒíƒœ í™•ì¸
        const permission = Notification.permission;
        log(`í˜„ì¬ ì•Œë¦¼ ê¶Œí•œ: ${permission}`);

        if (permission === 'granted') {
          document.getElementById('subscribe').disabled = false;
          document.getElementById('testLocal').disabled = false;
        }
      });
    </script>
  </body>
</html>
